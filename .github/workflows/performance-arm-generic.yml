name: Performance-arm-generic

on:
  schedule:
    - cron: "01 08 * * 1-5" # UTC 08:01 every weekday
  workflow_dispatch: {}

jobs:
  performance:
    name: Performance-arm
    runs-on: ubuntu-22.04-arm
  
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential
      - name: Download Datasets
        run: bash ./scripts/download_annbench_datasets.sh
      - name: Install dependencies
        run:  sudo bash ./scripts/deps/install_deps_ubuntu.sh

      - name: Build test executables
        run: cmake -B build-release -S . -DDISABLE_NEON_FORCE=ON -DDISABLE_SVE_FORCE=ON -DENABLE_TOOLS=ON -DCMAKE_BUILD_TYPE=Release &&cmake --build build-release -j6

       # FP32 Tests
      - name: Run Perf - FP32
        id: test-fp32
        continue-on-error: true
        run: |
          echo "::group::FP32 Performance Tests"
          ./build-release/tools/eval/eval_performance .github/perf-fp32.yml 2>&1 | tee /tmp/perf-fp32.log
          echo "::endgroup::"
      
      # FP16 Tests
      - name: Run Perf - FP16
        id: test-fp16
        continue-on-error: true
        run: |
          echo "::group::FP16 Performance Tests"
          ./build-release/tools/eval/eval_performance .github/perf-fp16.yml 2>&1 | tee /tmp/perf-fp16.log
          echo "::endgroup::"
      
      # BF16 Tests
      - name: Run Perf - BF16
        id: test-bf16
        continue-on-error: true
        run: |
          echo "::group::BF16 Performance Tests"
          ./build-release/tools/eval/eval_performance .github/perf-bf16.yml 2>&1 | tee /tmp/perf-bf16.log
          echo "::endgroup::"
      
      # SQ8 Tests
      - name: Run Perf - SQ8
        id: test-sq8
        continue-on-error: true
        run: |
          echo "::group::SQ8 Performance Tests"
          ./build-release/tools/eval/eval_performance .github/perf-sq8.yml 2>&1 | tee /tmp/perf-sq8.log
          echo "::endgroup::"
      
      # SQ8_UNIFORM Tests
      - name: Run Perf - SQ8_UNIFORM
        id: test-sq8-uniform
        continue-on-error: true
        run: |
          echo "::group::SQ8_UNIFORM Performance Tests"
          ./build-release/tools/eval/eval_performance .github/perf-sq8_uniform.yml 2>&1 | tee /tmp/perf-sq8_uniform.log
          echo "::endgroup::"
      
      # SQ4 Tests
      - name: Run Perf - SQ4
        id: test-sq4
        continue-on-error: true
        run: |
          echo "::group::SQ4 Performance Tests"
          ./build-release/tools/eval/eval_performance .github/perf-sq4.yml 2>&1 | tee /tmp/perf-sq4.log
          echo "::endgroup::"
      
      # SQ4_UNIFORM Tests
      - name: Run Perf - SQ4_UNIFORM
        id: test-sq4-uniform
        continue-on-error: true
        run: |
          echo "::group::SQ4_UNIFORM Performance Tests"
          ./build-release/tools/eval/eval_performance .github/perf-sq4_uniform.yml 2>&1 | tee /tmp/perf-sq4_uniform.log
          echo "::endgroup::"
      
      # PQ Tests
      - name: Run Perf - PQ
        id: test-pq
        continue-on-error: true
        run: |
          echo "::group::PQ Performance Tests"
          ./build-release/tools/eval/eval_performance .github/perf-pq.yml 2>&1 | tee /tmp/perf-pq.log
          echo "::endgroup::"
      
    
      
      # RABITQ Tests
      - name: Run Perf - RABITQ
        id: test-rabitq
        continue-on-error: true
        run: |
          echo "::group::RABITQ Performance Tests"
          ./build-release/tools/eval/eval_performance .github/perf-rabitq.yml 2>&1 | tee /tmp/perf-rabitq.log
          echo "::endgroup::"
      
      # Summary of test results
      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results Summary"
          echo "| Quantization Method | Status |"
          echo "|---------------------|--------|"
          echo "| FP32 | ${{ steps.test-fp32.outcome }} |"
          echo "| FP16 | ${{ steps.test-fp16.outcome }} |"
          echo "| BF16 | ${{ steps.test-bf16.outcome }} |"
          echo "| SQ8 | ${{ steps.test-sq8.outcome }} |"
          echo "| SQ8_UNIFORM | ${{ steps.test-sq8-uniform.outcome }} |"
          echo "| SQ4 | ${{ steps.test-sq4.outcome }} |"
          echo "| SQ4_UNIFORM | ${{ steps.test-sq4-uniform.outcome }} |"
          echo "| PQ | ${{ steps.test-pq.outcome }} |"
          echo "| RABITQ | ${{ steps.test-rabitq.outcome }} |"
          
          # Show any errors from log files
          echo ""
          echo "## Error Details"
          for log in /tmp/perf-*.log; do
            if [ -f "$log" ]; then
              method=$(basename "$log" .log | sed 's/perf-//')
              if grep -q "Error\|ERROR\|error\|Failed\|FAILED\|failed" "$log"; then
                echo "### $method errors:"
                grep -A 5 -B 5 -i "error\|failed" "$log" | tail -20
                echo ""
              fi
            fi
          done
      
      
      # Upload logs as artifacts for debugging
      - name: Upload Test Logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: performance-test-logs
          path: /tmp/perf-*.log
          retention-days: 7