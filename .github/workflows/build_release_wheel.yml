name: Build and Publish Wheels

on:
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to build (e.g., 3.10). If empty, builds all.'
        required: false
        type: string
      arch:
        description: 'Architecture to build (x86_64 or aarch64). If empty, builds all.'
        required: false
        type: string
  release:
    types: [published]

env:
  PY_FILTER: ${{ inputs.python-version || '' }}
  ARCH_FILTER: ${{ inputs.arch || '' }}
  CIBW_TEST_COMMAND_BASE: pip install numpy && bash /project/scripts/python/run_example_scripts.sh

jobs:
  build_wheels_modern:
    name: Build wheels for Python ${{ matrix.python }} on ${{ matrix.arch }}
    runs-on: ${{ matrix.arch == 'x86_64' && 'ubuntu-latest' || 'ubuntu-22.04-arm' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - python: "3.13"
            python_tag: "313"
            arch: "x86_64"
          - python: "3.13"
            python_tag: "313"
            arch: "aarch64"
          - python: "3.12"
            python_tag: "312"
            arch: "x86_64"
          - python: "3.12"
            python_tag: "312"
            arch: "aarch64"
          - python: "3.11"
            python_tag: "311"
            arch: "x86_64"
          - python: "3.11"
            python_tag: "311"
            arch: "aarch64"
          - python: "3.10"
            python_tag: "310"
            arch: "x86_64"
          - python: "3.10"
            python_tag: "310"
            arch: "aarch64"
          - python: "3.9"
            python_tag: "39"
            arch: "x86_64"
          - python: "3.9"
            python_tag: "39"
            arch: "aarch64"
          - python: "3.8"
            python_tag: "38"
            arch: "x86_64"
          - python: "3.8"
            python_tag: "38"
            arch: "aarch64"
          - python: "3.7"
            python_tag: "37"
            arch: "x86_64"
          - python: "3.7"
            python_tag: "37"
            arch: "aarch64"
    steps:
      - uses: actions/checkout@v4
        if: ${{ (env.PY_FILTER == '' || env.PY_FILTER == matrix.python) && (env.ARCH_FILTER == '' || env.ARCH_FILTER == matrix.arch) }}
        with:
          fetch-depth: 0

      - name: Build wheels
        if: ${{ (env.PY_FILTER == '' || env.PY_FILTER == matrix.python) && (env.ARCH_FILTER == '' || env.ARCH_FILTER == matrix.arch) }}
        uses: pypa/cibuildwheel@v2.20.0
        with:
          package-dir: python
        env:
          CIBW_ARCHS: ${{ matrix.arch }}
          CIBW_BUILD: cp${{ matrix.python_tag }}-*
          CIBW_TEST_COMMAND: ${{ env.CIBW_TEST_COMMAND_BASE }}

      - uses: actions/upload-artifact@v5
        if: ${{ (env.PY_FILTER == '' || env.PY_FILTER == matrix.python) && (env.ARCH_FILTER == '' || env.ARCH_FILTER == matrix.arch) }}
        with:
          name: wheels-${{ matrix.python }}-${{ matrix.arch }}
          path: ./wheelhouse/*.whl
          if-no-files-found: error

  build_wheels_py36:
    name: Build wheels for Python 3.6 on ${{ matrix.arch }}
    runs-on: ${{ matrix.arch == 'x86_64' && 'ubuntu-latest' || 'ubuntu-22.04-arm' }}
    strategy:
      fail-fast: false
      matrix:
        arch: ["x86_64", "aarch64"]
    steps:
      - uses: actions/checkout@v4
        if: ${{ (env.PY_FILTER == '' || env.PY_FILTER == '3.6') && (env.ARCH_FILTER == '' || env.ARCH_FILTER == matrix.arch) }}
        with:
          fetch-depth: 0

      - name: Build wheels for Python 3.6
        if: ${{ (env.PY_FILTER == '' || env.PY_FILTER == '3.6') && (env.ARCH_FILTER == '' || env.ARCH_FILTER == matrix.arch) }}
        uses: pypa/cibuildwheel@v2.11.4
        with:
          package-dir: python
        env:
          CIBW_ARCHS: ${{ matrix.arch }}
          CIBW_BUILD: cp36-*
          CIBW_TEST_COMMAND: ${{ env.CIBW_TEST_COMMAND_BASE }}

      - uses: actions/upload-artifact@v5
        if: ${{ (env.PY_FILTER == '' || env.PY_FILTER == '3.6') && (env.ARCH_FILTER == '' || env.ARCH_FILTER == matrix.arch) }}
        with:
          name: wheels-3.6-${{ matrix.arch }}
          path: ./wheelhouse/*.whl
          if-no-files-found: error

  publish:
    name: Publish packages
    needs: [build_wheels_modern, build_wheels_py36]
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'release' && github.event.action == 'published' }}
    steps:
      - uses: actions/download-artifact@v5
        with:
          path: dist
          merge-multiple: true

      - name: List distribution files
        id: list_files
        run: |
          if [ -z "$(ls -A dist)" ]; then
            echo "No build artifacts found. Skipping publish."
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Found artifacts to publish."
            ls -la dist/
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Determine package version
        if: steps.list_files.outputs.should_publish == 'true'
        id: package_version
        run: |
          FIRST_WHEEL=$(ls dist/pyvsag-*.whl 2>/dev/null | head -n 1)
          if [ -z "$FIRST_WHEEL" ]; then
            echo "No pyvsag wheels found to extract version."
            exit 1
          fi
          BASENAME=$(basename "$FIRST_WHEEL")
          VERSION=${BASENAME#pyvsag-}
          VERSION=${VERSION%%-*}
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Publish to TestPyPI
        if: steps.list_files.outputs.should_publish == 'true'
        uses: pypa/gh-action-pypi-publish@v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository-url: https://test.pypi.org/legacy/
          verbose: true

      - name: Smoke test TestPyPI artifact
        if: steps.list_files.outputs.should_publish == 'true'
        run: |
          python -m venv /tmp/pyvsag-smoke
          source /tmp/pyvsag-smoke/bin/activate
          pip install --upgrade pip
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple "pyvsag==${{ steps.package_version.outputs.version }}"
          python - <<'PY'
          import pyvsag
          print(f"Imported pyvsag {pyvsag.__version__} from TestPyPI")
          PY

      - name: Publish to PyPI
        if: steps.list_files.outputs.should_publish == 'true'
        uses: pypa/gh-action-pypi-publish@v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          verbose: true

      - name: Upload to GitHub Release
        if: steps.list_files.outputs.should_publish == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl

